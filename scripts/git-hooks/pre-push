#!/bin/bash
#
# Git Pre-Push Hook: Health Check + Property-Based Testing
#
# 1. Health check (syntax, optional deps, type-check) – catches e.g. "Module not found" early.
# 2. Property-based tests on changed files.
#
# To install this hook:
#   cp scripts/git-hooks/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push
#
# With Husky (prepare script runs "husky install"):
#   Husky will use .husky/pre-push if present; otherwise copy from scripts/git-hooks/pre-push.
#
# To bypass this hook (not recommended):
#   git push --no-verify
#
# Task: 13.2 Add CI/CD integration and automation
# Feature: property-based-testing

set -e
cd "$(git rev-parse --show-toplevel)"

echo "Running pre-push checks..."
echo ""

# Consume stdin once: detect if pushing main and save refs for PBT
REFS_FILE=$(mktemp)
trap "rm -f '$REFS_FILE'" EXIT
PUSHING_MAIN=0
REF_COUNT=0
while read local_ref local_sha remote_ref remote_sha; do
    echo "$local_ref $local_sha $remote_ref $remote_sha" >> "$REFS_FILE"
    REF_COUNT=$((REF_COUNT + 1))
    if [ "$local_ref" = "refs/heads/main" ]; then
        PUSHING_MAIN=1
    fi
done
# Husky v7+ does not forward stdin to the hook, so refs are often empty. If we have no refs, treat current branch as pushed (e.g. "git push origin main").
if [ "$REF_COUNT" -eq 0 ]; then
    CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || git rev-parse --abbrev-ref HEAD 2>/dev/null)
    if [ "$CURRENT_BRANCH" = "main" ]; then
        PUSHING_MAIN=1
        LOCAL_SHA=$(git rev-parse HEAD)
        REMOTE_SHA=$(git rev-parse origin/main 2>/dev/null || echo "$LOCAL_SHA")
        echo "refs/heads/main $LOCAL_SHA refs/heads/main $REMOTE_SHA" >> "$REFS_FILE"
    fi
fi

# When pushing main: bump build number first so the push includes it (rollback on failure)
DID_BUMP=0
if [ "$PUSHING_MAIN" = "1" ]; then
    echo "▶ Bump build number (main)"
    NEW_BUILD=$(node scripts/bump-patch-version.js 2>/dev/null) || true
    if [ -n "$NEW_BUILD" ]; then
        git add package.json
        if ! git diff --staged --quiet; then
            git commit -m "chore: bump build to $NEW_BUILD"
            echo "   Build number $NEW_BUILD committed."
            DID_BUMP=1
        else
            echo "   (build unchanged)"
        fi
    fi
    echo ""
fi

# 1. Health check (syntax, optional-deps, type-check)
echo "▶ Health check (syntax, optional deps, type-check)"
if ! npm run health-check; then
    echo ""
    echo "❌ Health check failed (syntax / optional deps / type-check)."
    [ "$DID_BUMP" = "1" ] && git reset --hard HEAD~1
    echo "   Fix the errors above before pushing."
    echo "   Bypass: git push --no-verify"
    exit 1
fi
echo ""

# 2. Property-based tests for each ref
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi
    echo "Running property-based tests for changes in $remote_sha..$local_sha"
    if ! ./scripts/run-pbt-on-changes.sh --base "$remote_sha" --head "$local_sha"; then
        echo ""
        echo "❌ Property-based tests failed!"
        [ "$DID_BUMP" = "1" ] && git reset --hard HEAD~1
        echo "   Fix the failing tests before pushing."
        echo "   Bypass: git push --no-verify"
        exit 1
    fi
done < "$REFS_FILE"

echo "✅ Property-based tests passed!"
exit 0
