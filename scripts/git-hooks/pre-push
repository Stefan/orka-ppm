#!/bin/bash
#
# Git Pre-Push Hook: Health Check + Property-Based Testing
#
# 1. Health check (syntax, optional deps, type-check) – catches e.g. "Module not found" early.
# 2. Property-based tests on changed files.
#
# To install this hook:
#   cp scripts/git-hooks/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push
#
# With Husky (prepare script runs "husky install"):
#   Husky will use .husky/pre-push if present; otherwise copy from scripts/git-hooks/pre-push.
#
# To bypass this hook (not recommended):
#   git push --no-verify
#
# Task: 13.2 Add CI/CD integration and automation
# Feature: property-based-testing

set -e
cd "$(git rev-parse --show-toplevel)"

echo "Running pre-push checks..."
echo ""

# 1. Health check (syntax, optional-deps, type-check)
echo "▶ Health check (syntax, optional deps, type-check)"
if ! npm run health-check; then
    echo ""
    echo "❌ Health check failed (syntax / optional deps / type-check)."
    echo "   Fix the errors above before pushing."
    echo "   Bypass: git push --no-verify"
    exit 1
fi
echo ""

# Get the remote and branch being pushed to
remote="$1"
url="$2"

# Read stdin to get the list of refs being pushed
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Branch is being deleted, skip tests
        continue
    fi
    
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch, compare with main
        range="origin/main...$local_sha"
    else
        # Existing branch, compare with remote
        range="$remote_sha..$local_sha"
    fi
    
    echo "Running property-based tests for changes in $range"
    
    # Run PBT on changes
    if ! ./scripts/run-pbt-on-changes.sh --base "$remote_sha" --head "$local_sha"; then
        echo ""
        echo "❌ Property-based tests failed!"
        echo ""
        echo "Please fix the failing tests before pushing."
        echo "To bypass this check (not recommended), use: git push --no-verify"
        echo ""
        exit 1
    fi
done

echo "✅ Property-based tests passed!"
exit 0
